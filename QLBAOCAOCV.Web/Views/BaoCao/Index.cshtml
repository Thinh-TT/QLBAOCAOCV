@{
    var role = Context.Session.GetString("Role");
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">
        @TempData["Error"]
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">
        @TempData["Success"]
    </div>
}

@model List<QLBAOCAOCV.DAL.Entities.BaoCao>

@{
    ViewData["Title"] = "Report List";
}


<a asp-action="Create" class="btn btn-success mb-3">
    + Add Report
</a>

<h2>Temperature & Humidity Report List</h2>

<form method="get" class="row g-2 mb-3">
    <div class="col-md-2">
        <label>From Date</label>
        <input type="date" name="fromDate" class="form-control"
               value="@ViewBag.FromDate?.ToString("yyyy-MM-dd")" />
    </div>

    <div class="col-md-2">
        <label>To Date</label>
        <input type="date" name="toDate" class="form-control"
               value="@ViewBag.ToDate?.ToString("yyyy-MM-dd")" />
    </div>

    
        
        @if (role == "Admin")
        {
        <div class="col-md-3">
            <label>Employee</label>
            <select name="maNV" class="form-control" asp-items="ViewBag.NhanViens">
                <option value="">-- All --</option>
            </select>
        </div>
        }
        
   

    <div class="col-md-3">
        <label>Room</label>
        <select name="maPhong" class="form-control" asp-items="ViewBag.Phongs">
            <option value="">-- All --</option>
        </select>
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">
            Search
        </button>
    </div>
    @if (role == "User")
    {
        <div class="col-md-2 d-flex align-items-end">
        </div>
    }
    

    <div class="col-md-2 d-flex align-items-end">

        <a asp-action="Index"
           asp-route-fromDate="@DateTime.Today.ToString("yyyy-MM-dd")"
           class="btn btn-warning w-100">
            Today
        </a>

    </div>

    <div class="col-md-2 d-flex align-items-end">

        <a asp-action="ExportExcel"
           asp-route-fromDate="@ViewBag.FromDate"
           asp-route-toDate="@ViewBag.ToDate"
           asp-route-maNV="@ViewBag.MaNV"
           asp-route-maPhong="@ViewBag.MaPhong"
           class="btn btn-success w-100">
            Export to Excel
        </a>
    </div>
</form>

<table class="table table-bordered table-hover align-middle">
    <thead class="table-light">
        <tr>
            <th>Report Date</th>
            <th>Employee</th>
            <th>Room</th>
            <th>Temperature (°C)</th>
            <th>Humidity (%)</th>
            <th>Status</th>
            <th>Confirmation Date</th>
            <th>Notes</th>
            @if (role == "Admin")
            {
                <th>Actions</th>
            }
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.NgayBC.ToString("dd/MM/yyyy HH:mm")</td>
                <td>@item.NhanVien?.TenNV</td>
                <td>@item.Phong?.TenPhong</td>
                <td>@item.NhietDo</td>
                <td>@item.DoAm</td>

                <!-- TRẠNG THÁI -->
                <td class="text-center">
                    @if (item.TrangThai == null)
                    {
                        <span class="badge bg-secondary">Pending</span>
                    }
                    else if (item.TrangThai == 0)
                    {
                        <span class="badge bg-danger">Failed</span>
                    }
                    else if (item.TrangThai == 1)
                    {
                        <span class="badge bg-success">Passed</span>
                    }
            </td>

            <!-- NGÀY XÁC NHẬN -->
            <td>
                @(item.NgayXacNhan.HasValue
                                ? item.NgayXacNhan.Value.ToString("dd/MM/yyyy HH:mm")
                                : "-")
                </td>

                <!-- GHI CHÚ -->
                <td>
                    @(!string.IsNullOrEmpty(item.GhiChuBC) ? item.GhiChuBC : "-")
                </td>

                <!-- HÀNH ĐỘNG -->
                @if (role == "Admin")
                {
                    <td class="text-center">
                        @if (item.TrangThai == null)
                        {
                            <form asp-action="XacNhan" method="post" style="display:inline">
                                <input type="hidden" name="id" value="@item.MaBC" />
                                <button type="submit"
                                        class="btn btn-sm btn-primary"
                                        onclick="return confirm('Are you sure you want to confirm this report?');">
                                    Confirm
                                </button>
                            </form>
                        }
                        else
                        {
                            <span class="text-muted">—</span>
                        }
                    </td>
                }
                
            </tr>
        }
    </tbody>
</table>
